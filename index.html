<script>
let pincodeLatLng = {};
let globalDistance = "N/A";
let globalETA = "N/A";
let globalEstimatedDateRange = "N/A";

fetch('cities.json')
  .then(res => res.json())
  .then(data => { pincodeLatLng = data; })
  .catch(err => console.log("Failed to load cities.json", err));

function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) ** 2 +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon / 2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

function formatDatePlusDays(days) {
  const date = new Date();
  date.setDate(date.getDate() + days);
  const options = { day: 'numeric', month: 'long' };
  return date.toLocaleDateString('en-IN', options);
}

function calculateEstimatedRange(etaText) {
  const numbers = etaText.match(/\d+/g);
  if (!numbers) return "N/A";
  const minDay = parseInt(numbers[0]);
  const maxDay = numbers[1] ? parseInt(numbers[1]) : minDay;
  return `${formatDatePlusDays(minDay)} ‚Äì ${formatDatePlusDays(maxDay)}`;
}

document.getElementById("pincode").addEventListener("input", function(){
  let pincode = this.value.trim();
  if (pincode.length === 6) {
    fetch(`https://api.postalpincode.in/pincode/${pincode}`)
      .then(res => res.json())
      .then(data => {
        if (data[0].Status === "Success") {
          let po = data[0].PostOffice[0];
          document.getElementById("state").value = po.State;
          document.getElementById("city").value = po.District;

          let sel = document.getElementById("postoffice");
          sel.innerHTML = '<option value="">Select Post Office</option>';
          data[0].PostOffice.forEach(p => {
            let opt = document.createElement("option");
            opt.value = p.Name;
            opt.text = p.Name;
            sel.appendChild(opt);
          });

          if (pincodeLatLng[pincode]) {
            const rampurLat = 28.8, rampurLng = 79.0;
            const dest = pincodeLatLng[pincode];
            const distance = haversine(rampurLat, rampurLng, dest.lat, dest.lng).toFixed(0);
            const eta = estimateDeliveryByDistance(distance);
            const range = calculateEstimatedRange(eta);

            globalDistance = `${distance} km`;
            globalETA = eta;
            globalEstimatedDateRange = range;

            document.getElementById("deliveryEstimate").innerText =
              `üìç Pincode found ‚Äì Distance: ${globalDistance}\n‚è≥ ETA: ${globalETA}\nüìÖ Estimated Delivery Date: ${globalEstimatedDateRange}\nüì¶ Delivery timeline is based on past experience. Sometimes it may delay by 1‚Äì3 days due to unavoidable circumstances.`;
          } else {
            globalDistance = "N/A";
            globalETA = "N/A";
            globalEstimatedDateRange = "N/A";
            document.getElementById("deliveryEstimate").innerText = "üìç Pincode found, but no distance data.";
          }
        }
      });
  }
});

function payNow() {
  const amount = document.getElementById("amountpaid").value;
  if (amount) {
    window.open(`upi://pay?pa=gamesplanet@upi&pn=GamesPlanet&am=${amount}`, "_blank");
  } else {
    alert("Please enter the amount first.");
  }
}

function sendOrder(){
  let now = new Date();
  let orderId = String(now.getDate()).padStart(2,'0') + String(now.getMonth()+1).padStart(2,'0') + now.getFullYear() +
                String(now.getHours()).padStart(2,'0') + String(now.getMinutes()).padStart(2,'0') + String(now.getSeconds()).padStart(2,'0') + '00';

  const getValue = (id) => document.getElementById(id)?.value || "";

  let msg = `üü¢ *Prepaid Order on WhatsApp*

*Order ID:* ${orderId}
*Name:* ${getValue("name")}
*Mobile:* ${getValue("mobile")}
*Alt Mobile:* ${getValue("altmobile")}
*Email:* ${getValue("email")}
*Address:* ${getValue("address")}
*Landmark:* ${getValue("landmark")}
*Pincode:* ${getValue("pincode")}
*State:* ${getValue("state")}
*District/City:* ${getValue("city")}
*Post office:* ${getValue("postoffice")}

*Product:* ${getValue("product")}
*Variant:* ${getValue("variant")}
*Base Price:* ‚Çπ${getValue("baseprice")}
*Discount Applied:* ‚Çπ${getValue("discount")}
*Amount Paid:* ‚Çπ${getValue("amountpaid")}

üìè Distance: ${globalDistance}
‚è≥ ETA: ${globalETA}
üìÖ Estimated Delivery Date: ${globalEstimatedDateRange}
üì¶ Delivery timeline is based on past experience. Sometimes it may delay by 1‚Äì3 days due to unavoidable circumstances.`;

  window.location.href = `https://wa.me/917983624797?text=${encodeURIComponent(msg)}`;
}
</script>
